---
kind: pipeline
name: test

workspace:
  base: /go
  path: github.com/sighupio/furyagent

pipeline:
  fetch:
    image: docker:git
    commands:
      - git fetch --tags

  lint:
    image: golang
    pull: always
    commands:
      - find . -name "*.go" | xargs gofmt -s -d
      #- go vet ./...
    when:
      event:
        - push
        - tag

  build-linux-push:
    image: golang
    pull: always
    environment:
      GOOS: linux
      GOARCH: amd64
      CGO_ENABLED: 0
    commands:
      - go mod vendor
      - go build
    when:
      event:
        - push

  build-darwin-push:
    group: build
    image: golang
    pull: always
    environment:
      GOOS: darwin
      GOARCH: amd64
      CGO_ENABLED: 0
    commands:
      - go mod vendor
      - go build
    when:
      event:
        - push

  build-release:
    image: goreleaser/goreleaser:v0.124
    pull: always
    environment:
      GITHUB_TOKEN:
        from_secret: GITHUB_TOKEN
    secrets:
      - GITHUB_TOKEN
    commands:
      - goreleaser --debug
    when:
      event:
        - tag
